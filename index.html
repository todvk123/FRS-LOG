<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกการปฏิบัติงานฯ ทุ่งครุ</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    </head>
<body>
    <nav class="navbar">
        <div class="container mx-auto flex flex-wrap justify-between items-center">
            <a href="#" id="navBrand" class="navbar-brand">THUNGKHRU FRS LOG</a> <div class="space-x-1 md:space-x-2">
                <a href="#" id="navHistory" class="nav-link">ประวัติ</a>
                <a href="#" id="navSettings" class="nav-link">ตั้งค่า</a>
            </div>
        </div>
    </nav>

    <div class="main-content-area">
        <div id="mainFormView">
             <div class="app-logo-container hidden md:block"> <div class="app-logo">THUNGKHRU FRS</div>
                 <h1 class="app-title">ระบบบันทึกการปฏิบัติงาน</h1>
            </div>

            <div class="form-wrapper">
                <div class="form-container">
                     <h1 class="section-title text-left mb-6 text-2xl md:text-3xl">บันทึกการปฏิบัติงาน</h1>

                    <form id="logForm">
                        <div class="mb-6"> <label for="date" class="form-label">วันที่ (Date):</label>
                            <input type="date" id="date" name="date" class="form-input" required>
                        </div>

                        <div class="mb-6">
                            <label for="missionType" class="form-label">ภารกิจ:</label>
                            <select id="missionType" name="missionType" class="form-select" required>
                                <option value="">-- เลือกประเภทภารกิจ --</option>
                                <option value="ติดต่อราชการ">ติดต่อราชการ</option>
                                <option value="เหตุ 501 บริการประชาชน">เหตุ 501 บริการประชาชน</option>
                                <option value="เหตุ 201-206 เหตุเพลิงไหม้">เหตุ 201-206 เหตุเพลิงไหม้</option>
                                </select>
                        </div>
                        
                        <div id="timeReportReceivedWrapper" class="mb-6 hidden">
                            <label for="timeReportReceived" class="form-label">เวลา รับแจ้งเหตุ:</label>
                            <input type="time" id="timeReportReceived" name="timeReportReceived" class="form-input">
                        </div>
                        <div id="timeW4Wrapper" class="mb-6 hidden">
                            <label for="timeW4" class="form-label">เวลาออก ว.4:</label>
                            <input type="time" id="timeW4" name="timeW4" class="form-input">
                        </div>
                        <div id="timeArrivedSceneWrapper" class="mb-6 hidden">
                            <label for="timeArrivedScene" class="form-label">เวลา ว.10 ถึงที่เกิดเหตุ:</label>
                            <input type="time" id="timeArrivedScene" name="timeArrivedScene" class="form-input">
                        </div>
                        <div id="timeLeftSceneWrapper" class="mb-6 hidden">
                            <label for="timeLeftScene" class="form-label">เวลา เลิก ว.10 ที่เกิดเหตุ:</label>
                            <input type="time" id="timeLeftScene" name="timeLeftScene" class="form-input">
                        </div>
                        <div id="timeArrivedStationWrapper" class="mb-6 hidden">
                            <label for="timeArrivedStation" class="form-label">เวลา ว.10 ถึงสถานี:</label>
                            <input type="time" id="timeArrivedStation" name="timeArrivedStation" class="form-input">
                        </div>

                        <div class="mb-6">
                            <label for="missionDetails" class="form-label">รายละเอียดภารกิจ / ว.8 เหตุ:</label>
                            <textarea id="missionDetails" name="missionDetails" class="form-textarea" rows="4" placeholder="กรอกรายละเอียด..." required></textarea>
                        </div>

                        <div class="mb-6">
                            <label for="location" class="form-label">สถานที่ไป/สถานที่เกิดเหตุ:</label>
                            <input type="text" id="location" name="location" class="form-input" placeholder="ระบุสถานที่" required>
                        </div>

                        <div class="mb-6">
                            <label for="supervisor" class="form-label">ชื่อผู้ควบคุม (เป็นนามเรียกขาน):</label>
                            <select id="supervisor" name="supervisor" class="form-select supervisor-select" required>
                                <option value="">-- เลือกผู้ควบคุม --</option>
                                </select>
                        </div>

                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-gray-700 mb-3">รถที่ออกปฎิบัติงาน และเลขไมล์กลับ</h3>
                            <div id="vehiclesContainer">
                                </div>
                            <button type="button" id="addVehicleButton" class="add-button mt-2">เพิ่มรถ +</button>
                        </div>

                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-gray-700 mb-3">ชื่อเจ้าหน้าที่ออกปฎิบัติงาน</h3>
                            <div id="officersContainer">
                                </div>
                            <button type="button" id="addOfficerButton" class="add-button mt-2">เพิ่มเจ้าหน้าที่ +</button>
                        </div>

                        <div class="mt-8 flex justify-end"> <button type="submit" class="submit-button">บันทึกข้อมูล</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="recentLogsContainer" class="form-wrapper">
                <h2 class="section-title text-left mb-4">ประวัติล่าสุด (5 รายการ)</h2>
                <div id="recentLogsDisplay" class="history-container min-h-[100px] flex items-center justify-center overflow-x-auto !p-0"> <p class="loading-text">กำลังโหลดข้อมูล...</p>
                </div>
            </div>
        </div>

        <div id="allHistoryView" class="hidden">
            <div class="history-container">
                <h2 class="section-title text-left mb-4">ประวัติการบันทึกทั้งหมด</h2>
                <div id="allLogsTableContainer" class="overflow-x-auto">
                    <p class="loading-text">กำลังโหลดข้อมูลประวัติทั้งหมด...</p>
                </div>
                <div id="paginationControlsContainer" class="pagination-controls mt-4">
                    </div>
            </div>
        </div>

        <div id="settingsView" class="hidden">
             <div class="settings-container"><h2 class="section-title text-left mb-4">ตั้งค่า</h2><p class="text-gray-600">ส่วนตั้งค่ายังไม่เปิดใช้งาน</p></div>
        </div>
    </div>

    <footer class="footer"> &copy; copyright 2025 by Todvk123 </footer>

    <script>
        // --- Global Variables, DOM Elements ---
        let allLogData = [];
        let currentPage = 1;
        const itemsPerPage = 25;
        let totalPages = 1;
        let fireEngineOptionsData = []; 
        let officerOptionsData = []; 

        const mainFormView = document.getElementById('mainFormView');
        const allHistoryView = document.getElementById('allHistoryView');
        const settingsView = document.getElementById('settingsView');
        
        const navBrand = document.getElementById('navBrand');
        const navHistory = document.getElementById('navHistory');
        const navSettings = document.getElementById('navSettings');
        const navLinks = [navBrand, navHistory, navSettings];

        const recentLogsDisplayDiv = document.getElementById('recentLogsDisplay');
        const allLogsTableContainerDiv = document.getElementById('allLogsTableContainer');
        
        const missionTypeSelect = document.getElementById('missionType');
        // Time field wrappers
        const timeReportReceivedWrapper = document.getElementById('timeReportReceivedWrapper');
        const timeW4Wrapper = document.getElementById('timeW4Wrapper');
        const timeArrivedSceneWrapper = document.getElementById('timeArrivedSceneWrapper');
        const timeLeftSceneWrapper = document.getElementById('timeLeftSceneWrapper');
        const timeArrivedStationWrapper = document.getElementById('timeArrivedStationWrapper');
        // Time input fields
        const timeReportReceivedInput = document.getElementById('timeReportReceived');
        const timeW4Input = document.getElementById('timeW4');
        const timeArrivedSceneInput = document.getElementById('timeArrivedScene');
        const timeLeftSceneInput = document.getElementById('timeLeftScene');
        const timeArrivedStationInput = document.getElementById('timeArrivedStation');

        const vehiclesContainer = document.getElementById('vehiclesContainer');
        const addVehicleButton = document.getElementById('addVehicleButton');
        const officersContainer = document.getElementById('officersContainer');
        const addOfficerButton = document.getElementById('addOfficerButton');
        const supervisorSelect = document.getElementById('supervisor'); 
        
        const paginationControlsDiv = document.getElementById('paginationControlsContainer'); 


        // --- Utility Functions ---
        function setTodayDate() {
            const today = new Date();
            const offset = today.getTimezoneOffset() * 60000;
            const localISOTime = (new Date(today.getTime() - offset)).toISOString().split('T')[0];
            if(document.getElementById('date')) {
                 document.getElementById('date').value = localISOTime;
            }
        }
        function showView(viewElement, activeLink) { 
            [mainFormView, allHistoryView, settingsView].forEach(v => v.classList.add('hidden'));
            if (viewElement) viewElement.classList.remove('hidden');
            // Since Tailwind is removed, active class might not have visual effect without CSS
            // navLinks.forEach(link => link.classList.remove('active')); 
            // if (activeLink) activeLink.classList.add('active');
        }
        
        function formatTimeDisplay(timeStr) {
            if (!timeStr || typeof timeStr !== 'string' || timeStr.trim() === '') {
                return ''; 
            }
            try {
                let hours, minutes;
                if (timeStr.includes("GMT") || timeStr.includes("เวลา") || timeStr.match(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/) || (new Date(timeStr).toString() !== "Invalid Date" && timeStr.length > 8 && timeStr.includes(":"))) {
                    const dateObjFromStr = new Date(timeStr);
                    if (!isNaN(dateObjFromStr.getTime())) {
                        hours = dateObjFromStr.getHours();
                        minutes = dateObjFromStr.getMinutes();
                    }
                } else if (timeStr.match(/^\d{1,2}:\d{2}(:\d{2})?$/)) { 
                    const timeParts = timeStr.split(':');
                    hours = parseInt(timeParts[0]);
                    minutes = parseInt(timeParts[1]);
                }

                if (hours !== undefined && minutes !== undefined && !isNaN(hours) && !isNaN(minutes)) {
                    let formattedHours = hours < 10 ? '0' + hours : String(hours);
                    let formattedMinutes = minutes < 10 ? '0' + minutes : String(minutes);
                    return `${formattedHours}:${formattedMinutes} น.`;
                } else {
                    return timeStr; 
                }
            } catch (e) {
                return timeStr; 
            }
        }

        function populateSelectWithOptions(selectElement, optionsArray, placeholderText, valueKey, textKey) {
            const currentSelectedValue = selectElement.value;
            while (selectElement.options.length > 1) { 
                selectElement.remove(1);
            }
        
            if (optionsArray && optionsArray.length > 0) {
                optionsArray.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item[valueKey]; 
                    option.textContent = item[textKey]; 
                    selectElement.appendChild(option);
                });
                if (currentSelectedValue && selectElement.querySelector(`option[value="${currentSelectedValue}"]`)) {
                     selectElement.value = currentSelectedValue;
                } else if (selectElement.options.length > 1 && currentSelectedValue === ' (กำลังโหลด...) ') {
                     if(selectElement.options[1] && selectElement.options[1].value === ' (กำลังโหลด...) ') {
                         selectElement.remove(1); 
                     }
                }
            } else { 
                 if (selectElement.options.length <=1 || (selectElement.options[1] && selectElement.options[1].value === ' (กำลังโหลด...) ')) {
                    if(selectElement.options[1] && selectElement.options[1].value === ' (กำลังโหลด...) ') selectElement.remove(1);
                    const noOption = document.createElement('option');
                    noOption.value = '';
                    noOption.textContent = optionsArray ? `ไม่พบข้อมูล${placeholderText}` : ' (กำลังโหลด...) ';
                    noOption.disabled = true;
                    selectElement.appendChild(noOption);
                }
            }
        }


        function fetchFireEngineList() {
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(data => { 
                        fireEngineOptionsData = data || [];
                        document.querySelectorAll('.vehicle-name-select').forEach(select => {
                            populateSelectWithOptions(select, fireEngineOptionsData, 'รถ', 'saveValue', 'displayValue');
                        });
                    })
                    .withFailureHandler(error => {
                        console.error("Error fetching fire engine data:", error); 
                        fireEngineOptionsData = [];
                         document.querySelectorAll('.vehicle-name-select').forEach(select => {
                            populateSelectWithOptions(select, [], 'รถ (Error)', 'saveValue', 'displayValue');
                        });
                    })
                    .getFireEngineData(); 
            } else { setTimeout(fetchFireEngineList, 1500); }
        }

        function fetchOfficerList() {
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(data => { 
                        officerOptionsData = data || [];
                        populateSelectWithOptions(supervisorSelect, officerOptionsData, 'ผู้ควบคุม', 'saveValue', 'displayValue');
                        document.querySelectorAll('.officer-name-select').forEach(select => {
                            populateSelectWithOptions(select, officerOptionsData, 'เจ้าหน้าที่', 'saveValue', 'displayValue');
                        });
                    })
                    .withFailureHandler(error => {
                        console.error("Error fetching officer data:", error);
                        officerOptionsData = [];
                        populateSelectWithOptions(supervisorSelect, [], 'ผู้ควบคุม (Error)', 'saveValue', 'displayValue');
                        document.querySelectorAll('.officer-name-select').forEach(select => populateSelectWithOptions(select, [], 'เจ้าหน้าที่ (Error)', 'saveValue', 'displayValue')); 
                    })
                    .getOfficerData(); 
            } else {
                setTimeout(fetchOfficerList, 1600); 
            }
        }


        function handleMissionTypeChange() {
            const selectedMission = missionTypeSelect.value;

            [timeReportReceivedWrapper, timeW4Wrapper, timeArrivedSceneWrapper, timeLeftSceneWrapper, timeArrivedStationWrapper].forEach(wrapper => {
                wrapper.classList.add('hidden');
            });
            [timeReportReceivedInput, timeW4Input, timeArrivedSceneInput, timeLeftSceneInput, timeArrivedStationInput].forEach(input => {
                input.required = false;
            });
            
            if (selectedMission === "") { 
                return; 
            }

            if (selectedMission === 'ติดต่อราชการ') {
                timeW4Wrapper.classList.remove('hidden');
                timeW4Input.required = true;
                timeArrivedStationWrapper.classList.remove('hidden');
                timeArrivedStationInput.required = true;
            } else if (selectedMission === 'เหตุ 501 บริการประชาชน') {
                timeW4Wrapper.classList.remove('hidden');
                timeW4Input.required = true;
                timeArrivedSceneWrapper.classList.remove('hidden');
                timeArrivedSceneInput.required = true;
                timeLeftSceneWrapper.classList.remove('hidden');
                timeLeftSceneInput.required = true;
                timeArrivedStationWrapper.classList.remove('hidden');
                timeArrivedStationInput.required = true;
            } else if (selectedMission === 'เหตุ 201-206 เหตุเพลิงไหม้') {
                timeReportReceivedWrapper.classList.remove('hidden');
                timeReportReceivedInput.required = true;
                timeW4Wrapper.classList.remove('hidden');
                timeW4Input.required = true;
                timeArrivedSceneWrapper.classList.remove('hidden');
                timeArrivedSceneInput.required = true;
                timeLeftSceneWrapper.classList.remove('hidden');
                timeLeftSceneInput.required = true;
                timeArrivedStationWrapper.classList.remove('hidden');
                timeArrivedStationInput.required = true;
            }
        }
        missionTypeSelect.addEventListener('change', handleMissionTypeChange);
        
        function addVehicleEntry() {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'vehicle-entry dynamic-item-container'; // Removed grid classes, will stack naturally

            const vehicleNameDiv = document.createElement('div');
            vehicleNameDiv.className = 'w-full mb-2'; // Added margin-bottom
            const vehicleNameLabel = document.createElement('label');
            vehicleNameLabel.className = 'form-label text-xs'; 
            vehicleNameLabel.textContent = 'ชื่อรถ:';
            vehicleNameDiv.appendChild(vehicleNameLabel);

            const vehicleNameSelect = document.createElement('select');
            vehicleNameSelect.name = 'vehicle_save_value[]'; 
            vehicleNameSelect.className = 'form-select vehicle-name-select text-sm'; 

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '-- เลือกรถ --';
            vehicleNameSelect.appendChild(defaultOption);
            populateSelectWithOptions(vehicleNameSelect, fireEngineOptionsData, 'รถ', 'saveValue', 'displayValue');
            
            vehicleNameDiv.appendChild(vehicleNameSelect);
            entryDiv.appendChild(vehicleNameDiv);

            const mileageDiv = document.createElement('div');
            mileageDiv.className = 'w-full mb-2'; // Added margin-bottom
            const mileageLabel = document.createElement('label');
            mileageLabel.className = 'form-label text-xs';
            mileageLabel.textContent = 'เลขไมล์กลับ:';
            mileageDiv.appendChild(mileageLabel);

            const mileageInput = document.createElement('input');
            mileageInput.type = 'number';
            mileageInput.name = 'vehicle_mileage[]';
            mileageInput.className = 'form-input vehicle-mileage text-sm'; 
            mileageInput.placeholder = 'ตัวเลข';
            mileageDiv.appendChild(mileageInput);
            entryDiv.appendChild(mileageDiv);

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-button remove-vehicle-button w-full'; 
            removeBtn.textContent = 'ลบ';
            removeBtn.addEventListener('click', function() {
                this.closest('.vehicle-entry').remove();
            });
            entryDiv.appendChild(removeBtn);

            vehiclesContainer.appendChild(entryDiv);
        }
        addVehicleButton.addEventListener('click', addVehicleEntry);

        function addOfficerEntry() {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'officer-entry dynamic-item-container'; // Removed flex, will stack
            
            const officerSelect = document.createElement('select');
            officerSelect.name = 'officer_save_value[]'; 
            officerSelect.className = 'form-select officer-name-select text-sm w-full mb-2'; // Added w-full and margin-bottom
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '-- เลือกเจ้าหน้าที่ --';
            officerSelect.appendChild(defaultOption);
            
            populateSelectWithOptions(officerSelect, officerOptionsData, 'เจ้าหน้าที่', 'saveValue', 'displayValue');

            entryDiv.appendChild(officerSelect);

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-button remove-officer-button w-full'; // Full width for remove button
            removeBtn.textContent = 'ลบ';
            removeBtn.addEventListener('click', function() {
                this.closest('.officer-entry').remove();
            });
            entryDiv.appendChild(removeBtn);
            
            officersContainer.appendChild(entryDiv);
        }
        addOfficerButton.addEventListener('click', addOfficerEntry);

        function createTableFromData(logsArray, targetDiv) { 
            targetDiv.innerHTML = ''; 
            // targetDiv.classList.remove('items-center', 'justify-center'); // Not needed without CSS framework

            if (!logsArray || logsArray.length === 0) {
                targetDiv.innerHTML = '<p class="no-logs-text">ยังไม่มีข้อมูลการบันทึก</p>';
                // targetDiv.classList.add('items-center', 'justify-center'); // Not needed
                return;
            }

            const table = document.createElement('table');
            // table.className = 'logs-table all-history-table w-full text-sm text-left'; // Classes might not apply
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>วันที่</th>
                    <th>ภารกิจ</th>
                    <th>สถานที่</th>
                    <th>รถที่ใช้</th>
                    <th>ผู้ควบคุม</th>
                    <th>เวลา ว.4</th>
                    <th>เวลาถึง ส.ดพ.</th>
                </tr>`;
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            
            const displayIndices = [0, 1, 8, 10, 9, 3, 6];

            logsArray.forEach(logEntry => {
                const tr = document.createElement('tr');
                // tr.className = 'border-b border-gray-700 hover:bg-gray-700'; // Classes might not apply
                displayIndices.forEach(originalIndex => {
                    const td = document.createElement('td');
                    let cellData = (logEntry && logEntry[originalIndex] !== undefined && logEntry[originalIndex] !== null) ? String(logEntry[originalIndex]) : '';
                    
                    if (originalIndex === 0) { 
                         try {
                            const dateParts = cellData.split('-');
                            if (dateParts.length === 3) {
                                const dateObj = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
                                if (!isNaN(dateObj.getTime())) {
                                    cellData = dateObj.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric', timeZone: 'Asia/Bangkok' });
                                }
                            }
                        } catch (e) { console.error("Date formatting error in table:", cellData, e); }
                    } else if (originalIndex === 3 || originalIndex === 6) { 
                        cellData = formatTimeDisplay(cellData);
                    }
                    td.textContent = cellData;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            targetDiv.appendChild(table);
        }
        
        function createRecentLogsTable(logsArray, targetDiv) {
            targetDiv.innerHTML = ''; 
            // targetDiv.classList.remove('items-center', 'justify-center');

            if (!logsArray || logsArray.length === 0) {
                targetDiv.innerHTML = '<p class="no-logs-text">ยังไม่มีข้อมูลการบันทึก</p>';
                // targetDiv.classList.add('items-center', 'justify-center');
                return;
            }

            const table = document.createElement('table');
            // table.className = 'logs-table w-full text-sm text-left'; 
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>วันที่</th>
                    <th>ภารกิจ</th>
                    <th>สถานที่</th>
                    <th>ว.4</th>
                    <th>ถึงส.ดพ.</th>
                    <th>ผู้ควบคุม</th>
                    <th>รถที่ออกฯ</th> 
                </tr>`;
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            
            const recentLogIndices = [0, 1, 8, 3, 6, 9, 10]; 

            logsArray.forEach(logEntry => {
                const tr = document.createElement('tr');
                // tr.className = 'border-b border-gray-700 hover:bg-gray-700';
                recentLogIndices.forEach(originalIndex => {
                    const td = document.createElement('td');
                    let cellData = (logEntry && logEntry[originalIndex] !== undefined && logEntry[originalIndex] !== null) ? String(logEntry[originalIndex]) : '';
                    
                    if (originalIndex === 0) { 
                         try {
                            const dateParts = cellData.split('-');
                            if (dateParts.length === 3) {
                                const dateObj = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
                                if (!isNaN(dateObj.getTime())) {
                                    cellData = dateObj.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric', timeZone: 'Asia/Bangkok' });
                                }
                            }
                        } catch (e) { console.error("Date formatting error in recent logs table:", cellData, e); }
                    } else if (originalIndex === 3 || originalIndex === 6) { 
                        cellData = formatTimeDisplay(cellData);
                    } else if (originalIndex === 8) { 
                        if (cellData.length > 15) {
                            cellData = cellData.substring(0, 15) + "...";
                        }
                    }
                    td.textContent = cellData;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            targetDiv.appendChild(table);
        }


        function displayRecentLogs(logs) { 
            createRecentLogsTable(logs.slice().reverse(), recentLogsDisplayDiv); 
        }
        function handleRecentLogFetchError(error) { 
            recentLogsDisplayDiv.innerHTML = `<p>เกิดข้อผิดพลาดโหลดประวัติล่าสุด: ${error.message}</p>`;
            // recentLogsDisplayDiv.classList.add('items-center', 'justify-center');
        }
        function loadRecentLogs() { 
             recentLogsDisplayDiv.innerHTML = '<p>กำลังโหลดข้อมูล...</p>';
             // recentLogsDisplayDiv.classList.add('items-center', 'justify-center');
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(displayRecentLogs)
                    .withFailureHandler(handleRecentLogFetchError)
                    .getRecentLogs();
            } else { setTimeout(loadRecentLogs, 1000); }
        }

        function updatePaginationUI() { 
            paginationControlsDiv.innerHTML = '';

            if (totalPages <= 0 || allLogData.length === 0) {
                // paginationControlsDiv.style.display = 'none'; // Not needed without CSS framework
                return;
            }
            // paginationControlsDiv.style.display = 'flex'; // Not needed

            const prevBtn = document.createElement('button');
            // prevBtn.className = 'pagination-button';
            prevBtn.textContent = 'ก่อนหน้า';
            prevBtn.disabled = currentPage === 1;
            prevBtn.addEventListener('click', () => {
                if (currentPage > 1) { currentPage--; renderAllHistoryPage(); }
            });

            const pageInfo = document.createElement('span');
            // pageInfo.className = 'page-info';
            pageInfo.textContent = `หน้า ${currentPage} จาก ${totalPages}`;
            
            const nextBtn = document.createElement('button');
            // nextBtn.className = 'pagination-button';
            nextBtn.textContent = 'ถัดไป';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.addEventListener('click', () => {
                if (currentPage < totalPages) { currentPage++; renderAllHistoryPage(); }
            });

            paginationControlsDiv.appendChild(prevBtn);
            paginationControlsDiv.appendChild(pageInfo);
            paginationControlsDiv.appendChild(nextBtn);
        }

        function renderAllHistoryPage() { 
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = allLogData.slice(startIndex, endIndex); 
            createTableFromData(pageData, allLogsTableContainerDiv); 
            updatePaginationUI();
        }
        function displayAllLogs(logs) { 
            allLogData = logs.slice().reverse(); 
            totalPages = Math.ceil(allLogData.length / itemsPerPage);
            if (totalPages === 0 && allLogData.length === 0) {
                 allLogsTableContainerDiv.innerHTML = '<p>ยังไม่มีข้อมูลการบันทึก</p>';
                 // allLogsTableContainerDiv.classList.add('items-center', 'justify-center');
                 totalPages = 1; 
            } else if (totalPages === 0) {
                 totalPages = 1;
            }
            currentPage = 1;
            renderAllHistoryPage();
        }
        function handleAllLogFetchError(error) { 
            allLogsTableContainerDiv.innerHTML = `<p>เกิดข้อผิดพลาดโหลดประวัติทั้งหมด: ${error.message}</p>`;
            // allLogsTableContainerDiv.classList.add('items-center', 'justify-center');
            allLogData = []; totalPages = 1; currentPage = 1; updatePaginationUI();
        }
        function fetchAllLogs() { 
            allLogsTableContainerDiv.innerHTML = '<p>กำลังโหลดข้อมูลประวัติทั้งหมด...</p>';
            // allLogsTableContainerDiv.classList.add('items-center', 'justify-center');
            // paginationControlsDiv.style.display = 'none'; 
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(displayAllLogs)
                    .withFailureHandler(handleAllLogFetchError)
                    .getAllLogEntries();
            } else { setTimeout(fetchAllLogs, 1000); }
        }
        
        navBrand.addEventListener('click', (e) => { e.preventDefault(); showView(mainFormView, navBrand); });
        navHistory.addEventListener('click', (e) => {
            e.preventDefault();
            showView(allHistoryView, navHistory);
            if (allLogData.length === 0) { 
                fetchAllLogs(); 
            } else { 
                renderAllHistoryPage(); 
            }
        });
        navSettings.addEventListener('click', (e) => { e.preventDefault(); showView(settingsView, navSettings); });

        document.getElementById('logForm').addEventListener('submit', function(event) {
            event.preventDefault();
            Swal.fire({ title: 'กำลังบันทึกข้อมูล...', text: 'กรุณารอสักครู่', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            const vehicles = [];
            document.querySelectorAll('#vehiclesContainer .vehicle-entry').forEach(entry => {
                const nameSaveValue = entry.querySelector('.vehicle-name-select').value; 
                const mileage = entry.querySelector('.vehicle-mileage').value.trim();
                if (nameSaveValue || mileage) { 
                    vehicles.push({ name: nameSaveValue, mileage: mileage }); 
                }
            });

            const officers = [];
            document.querySelectorAll('#officersContainer .officer-entry').forEach(entry => {
                const selectedOfficerSaveValue = entry.querySelector('.officer-name-select').value; 
                if (selectedOfficerSaveValue) {
                    officers.push(selectedOfficerSaveValue); 
                }
            });
            
            const supervisorToSave = supervisorSelect.value; 

            const formData = {
                date: document.getElementById('date').value,
                missionType: document.getElementById('missionType').value,
                timeReportReceived: timeReportReceivedInput.value,
                timeW4: timeW4Input.value,
                timeArrivedScene: timeArrivedSceneInput.value,
                timeLeftScene: timeLeftSceneInput.value,
                timeArrivedStation: timeArrivedStationInput.value,
                missionDetails: document.getElementById('missionDetails').value,
                location: document.getElementById('location').value,
                supervisor: supervisorToSave, 
                vehicles: vehicles,
                officers: officers 
            };
            
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(response => {
                        if (response.status === "success") {
                            Swal.fire({ icon: 'success', title: 'สำเร็จ!', text: response.message });
                            document.getElementById('logForm').reset();
                            setTodayDate();
                            handleMissionTypeChange(); 
                            vehiclesContainer.innerHTML = ''; 
                            officersContainer.innerHTML = '';
                            addVehicleEntry(); 
                            addOfficerEntry(); 
                            supervisorSelect.value = ""; 


                            loadRecentLogs(); 
                            if (!allHistoryView.classList.contains('hidden')) {
                                fetchAllLogs(); 
                            } else { 
                                allLogData = [];
                            }
                        } else {
                            Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด!', text: response.message || 'ไม่สามารถบันทึกข้อมูลได้' });
                        }
                    })
                    .withFailureHandler(error => Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาดร้ายแรง!', text: 'ไม่สามารถติดต่อ Server: ' + error.message }))
                    .logData(formData);
            } else {
                 Swal.fire({ icon: 'error', title: 'ข้อผิดพลาดการเชื่อมต่อ!', text: 'ไม่สามารถเชื่อมต่อ Google Script โปรดรีเฟรช' });
            }
        });

        window.onload = function() {
            setTodayDate();
            showView(mainFormView, navBrand); 
            fetchFireEngineList(); 
            fetchOfficerList(); 
            loadRecentLogs();
            handleMissionTypeChange(); 
            addVehicleEntry(); 
            addOfficerEntry(); 
        };
    </script>
</body>
</html>
